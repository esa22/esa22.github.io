<!DOCTYPE html>
<html lang="pt">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<style>
  .axis path, .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
      //shape-rendering: geometricPrecision;
  }   
  .axis .grid-line{
      stroke: black;
      stroke-opacity: .2;
      shape-rendering: crispEdges;
  }
  #fittedLineSalBudget {
      shape-rendering: geometricPrecision;
      stroke: cadetblue;
      stroke-width: 6px;
      fill: none;
      stroke-linecap: round;
  }
  .muniBubble {
      stroke-width: 1px;
  }
  circle.RM_Baixada_Santista {
      //stroke: gold;
  }
  div#tooltip {
      position: absolute;
      padding: 0px 2px 0px 2px;
      text-align: center;
      background: cyan;
      color: olivedrab;
      border: 2px solid;
	    border-radius: 5px;
  }
  svg g text.label {
      font-size: 16px; 
  }
  svg g text.title {
      font-size: 22px; 
  }
  svg g text.subtitle {
      font-size: 18px; 
  }
</style>
<body>

<!--Language Selection-->
<select id="langSelect" onchange="changeLanguage()">
  <option value="EN">English
  <option value="PT">Portugues
</select>
<!--MicroRegion Selection-->
<select id="microSelect" onchange="selectMicroRegion()">
  <option value="muniBubble">All Micro Regions
  <option value="Franco_da_Rocha">Franco da Rocha
  <option value="Guarulhos">Guarulhos
  <option value="Itapecerica_da_Serra">Itapecerica da Serra
  <option value="Mogi_das_Cruzes">Mogi das Cruzes
  <option value="Osasco">Osasco
  <option value="Santos">Santos
  <option value="Sao_Paulo">Sao Paulo
</select>


<p></p>
</body>
<script src="lib/d3.js"></script>
<script src="lib/chartObj.js"></script>
<script src="lib/eUtil.js"></script>
<script>
//Select the language
var lang = "EN"; //default
if(getUrlParam("l") === "PT"){
  //change actual language variable
  lang = "PT";
  //change language selection box
  document.getElementById("langSelect").selectedIndex = 1;
  //change language in other selection box
  changeMicroLang();
  //console.log("porewef");
}

//First establish and render a viewing area
var width = 960;
var height = 600;

//bubble coloring scheme
var bubbleColors = {main: "olivedrab", flash: "cyan", highlight: "yellow", background: "lightgray"};
var bubbleStrokeColor = {main: "gold", flash: "olivedrab", highlight: "olivedrab", background: "lightgray"};
var hatPathColor = {main: "cadetblue", background: "lightgray"};
var bubbleFillOpacity = {main: 0.8, flash: 0.9, background: 0.3, highlight: 0.9};
var bubbleStrokeOpacity = {main: 0.8, flash: 0.9, background: 0.3, highlight: 0.9};

//initialize chart object
//range stays at 0 to 30. Can zoom in or out on x. Good values are 180, 270, and 3300
var chart = chartObj()
        .y(d3.scale.linear().domain([0, 30]))
        .x(d3.scale.linear().domain([0, 270]));

//Load Data and Execute Script
d3.tsv("data/salaryData.txt")
  .row(function(d) {
  return {
    muniId: d.muniId, 
    muniName: d.muniName, 
    metroRegion: d.metroRegion, 
    microName: d.microName, 
    partyOfMayor2012: d.partyOfMayor2012, 
    pop1k2012: +d.pop1k2012,    //convert all vars below to number
    budget1M2012: +d.budget1M2012, 
    salaryMayor1k2014: +d.salaryMayor1k2014, 
    fitBudgetPop: +d.fitBudgetPop, 
    gapBudgetPop: +d.gapBudgetPop, 
    fitSalaryPop: +d.fitSalaryPop, 
    gapSalaryPop: +d.gapSalaryPop, 
    fitSalaryBudget: +d.fitSalaryBudget, 
    gapSalaryBudget: +d.gapSalaryBudget, 
    flagSalaryMissing: +d.flagSalaryMissing, 
    flagBudgetMissing: +d.flagBudgetMissing
  }; 
})
.get(function(error, data) {  
  //load variable names
  d3.tsv("data/varLabels.txt", function(error, varInfo) {
    console.log(varInfo);
    //Use "data" as dataset variable and "varInfo" for variable labels.
    //load data
    chart.observations(data)
         .variableInfo(varInfo);
    //render the chart
    chart.render();
  });
  //console.log(data[0]);   //see first row of dataset
  //console.log(data);   //see all of dataset
  //d3.select("p").text(data[0].muniName);
});

//reset the language
function changeLanguage(){
  lang = document.getElementById("langSelect").value;
  changeMicroLang();
  chart.render();
}

function changeMicroLang(){
  //Language in Selection Box
  var txt;
  if(lang === "EN"){
    txt = "All MicroRegions";
  }
  if(lang === "PT"){
    txt = "Todos os MicroRegioes";
  }
  document.getElementById("microSelect").children[0].innerHTML = txt;
}

var microRegion = "muniBubble";  //global var default
function selectMicroRegion(){
  microRegion = document.getElementById("microSelect").value;
  if(microRegion == "muniBubble"){
    //default settings
    d3.selectAll("." + microRegion)
      .transition().duration(400).ease("quad")
      .style("fill", bubbleColors.main)
      .style("opacity", bubbleFillOpacity.main)
      .style("stroke", bubbleStrokeColor.main)
      .style("stroke-opacity", bubbleStrokeOpacity.main);
    d3.selectAll(".dataMissing")
      .transition().duration(400).ease("quad")
      .style("fill", bubbleColors.background)
      .style("opacity", bubbleFillOpacity.background)
      .style("stroke", bubbleStrokeColor.background)
      .style("stroke-opacity", bubbleStrokeOpacity.background);
    d3.select("#fittedLineSalBudget")
      .transition().duration(400).ease("quad")
      .style("opacity", "0.8")
      .style("stroke", hatPathColor.main);
  } else {
    //selection highligting
    d3.selectAll(".muniBubble")
      .transition().duration(400).ease("quad")
      .style("fill", bubbleColors.background)
      .style("opacity", bubbleFillOpacity.background)
      .style("stroke", bubbleStrokeColor.background)
      .style("stroke-opacity", bubbleStrokeOpacity.background);
    d3.selectAll("." + microRegion)
      .transition().duration(400).ease("quad")
      .style("fill", bubbleColors.highlight)
      .style("opacity", bubbleFillOpacity.highlight)
      .style("stroke", bubbleStrokeColor.highlight)
      .style("stroke-opacity", bubbleStrokeOpacity.highlight);
    d3.select("#fittedLineSalBudget")
      .transition().duration(400).ease("quad")
      .style("opacity", "0.5")
      .style("stroke", hatPathColor.background);
  }
  
}

//get url parameters
function getUrlParam(name){
   if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
      return decodeURIComponent(name[1]);
}
</script>


<!--TODO
-(1) Address encoding for title 
-test across browsers (firefox not showing bubbles for some reason)
-Put into my website format
-->
